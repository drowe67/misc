\documentclass{article}
\usepackage{amsmath}
\usepackage{array}
\usepackage{siunitx}  
\begin{document}

\title{Low SNR FreeDV Mode}
\author{David Rowe VK5DGR}
\maketitle

\section{Glossary}

\begin{table}[h]
\centering
\begin{tabular}{l p{8cm} }
 \hline
 Acronym & Explanation \\
 \hline
 AWGN & Additive White Gaussian Noise - a communications channel with flat frequency response and additive noise \\
 CP & Cyclic Prefix \\
 FEC & Forward Error Correction \\
 LEO & Low earth orbit satellite channel, AWGN with large freq offset and Doppler shift (high rate of change of freq offset) \\
 GEO & Geosynchronous satellite channel, AWGN but high phase noise and large freq offset \\
 PTT & Push To Talk - voice communications where only one person is transmitting at any one time.  Common in two way radio but not mobile telephones  \\
 MPP & Multipath Poor channel, 1 Hz Doppler, 2ms delay spread, typical for US and Australian interstate propogation \\
 MPD & Multipath Disturbed channel, 2 Hz Doppler, 4ms delay spread, typical for UK Winter NVIS propogation \\
 \hline
\end{tabular}
\caption{Glossary of Acronyms}
\end{table}

\begin{table}[h]
\centering
\begin{tabular}{l l l}
 \hline
 Symbol & Explanation & Units \\
 \hline
 $B$ & Noise bandwidth & Hz \\
 $B_d$ & Doppler spreading bandwidth for HF channel model & Hz \\
 $E_b/N_0$ & Energy per bit on spectral noise density & dimensionless, dB\footnote{1} \\
 $N_p$ & Pilot insertion rate & dimensionless \\
 $R_b$ & Bit rate & Bits/second \\
 $R_s$ & Symbol rate & symbols/second \\
 $T_s$ & Symbol period & seconds \\
 $SNR$ & Signal to Noise Ratio & dB \\
 $S$ & Signal Power & Watts \\
 $N$ & Noise Power & Watts \\
 \hline
\end{tabular}
\caption{Glossary of Symbols}
\end{table}

\footnotetext[1]{Can be expressed as a linear ratio $E_b/N_0$ or $10log_{10}(E_b/N_0)$ dB}

\section{Introduction}

After 10 years development and on air experience with various FreeDV waveforms, we would like to develop a new waveform that outperforms and replaces a variety of existing modes such as 700C/D/E and 1600.  Requirements include \cite{freedv-020}:
\begin{enumerate}
\item Better performance than SSB at 0dB SNR on MPP and MPD channels.
\item A single mode that can handle MPP, MPD, GEO (e.g. QO-100), and replace several existing FreeDV modes, simplifying the end user experience.
\item For compliance with Export Control regulations, the minimum speech codec bit rate is 700 bit/s.
\end{enumerate}
It is acceptable for performance to gradually decrease as the multipath channel quality declines, but we would like the decline to be gradual, e.g. a few dB more power for operation on MPD versus MPP.

This document explores ways we can improve the existing OFDM modem waveforms in order to meet these requirements.

\section{Modem and Channel Models}

In this section we will develop theoretical models to help us explore performance limits.

For practical PTT voice systems algorithmic delay is limited to a few 100ms, which limits the FEC codeword size and hence the performance of the code.  For PSK channels a threshold $E_b/N_0=2 \, \si{dB}$ and a code rate $R=0.5$ is typical, where $E_b/N_0$ is the energy per payload data bit (coded $E_b/N_0$).  The lowest (threshold) SNR for a viable voice link is given by:
\begin{equation}
\label{eq:snr}
\begin{split}
\frac{S}{N} &= \frac{E_bR_b}{N_0B} \\
SNR &= 10log_{10}\left(\frac{E_b}{N_0}\right) + 10log_{10}\left(\frac{R_b}{B}\right) \quad [\si{dB}]
\end{split}
\end{equation}
where $R_b$ is the payload data bit rate, and $B$ is the bandwidth in which we measure SNR.  Given $Rb=700$ and $B=3000$ we have:
\begin{equation}
\begin{split}
SNR &= 2 + 10log_{10}(700/3000) \\
    &= -4.3 \, \si{dB}
\end{split}
\end{equation}
This is ideal performance for an AWGN channel.  In practice we must allocate some power to symbols used for synchronisation, such as pilot symbols used for frequency and phase estimation, or unique word bits used for frame synchronisation.  Synchronisation algorithms often struggle at low SNRs, introducing additional "implementation" losses.

Performance on multipath channels is significantly worse, in our use cases typically 5 dB.  On these channels, we may allocate some carrier power to deal with intersymbol interference (for example a cyclic prefix in OFDM modems).

A more complete model is:
\begin{equation}
\label{eq:snr_all}
SNR = 10log_{10}\left(\frac{E_b}{N_0}\right) + 10log_{10}\left(\frac{R_b}{B}\right) + L_p + L_{il} + L_{cp}
\end{equation}
where $L_p$ is the loss from power allocated to pilot symbols, $L_{il}$ is the real world implementation loss, and $L_{cp}$ is the loss in SNR due to the power allocated to the cyclic prefix.

TODO: Discuss Available bandwidth. 2000 Hz, using QPSK we can get 4000 bits/s.  Less overheads (which can be expressed as SNR or bandwidth reduction?).  We have 700 bits/s source code or 1400 bits/s with rate 0.5 FEC.

\subsection{Pilot symbol overhead}

In this section we explore the effect of inserting pilot symbols on the threshold SNR (\ref{eq:snr}). Consider a sequence of $N_p-1$ PSK data symbols that carry the modulated FEC codeword bits (e.g. data and parity bits) over the channel. We denote this sequence a modem \emph{modem frame}. The frame of $N_p-1$ symbols has a period of $T_f=(N_p-1)T_s$ seconds, where $T_s$ is the period of each symbol.  We wish to insert a single pilot symbol after the data symbols, creating a new frame $N_p$ symbols long, with period $T^\prime_f=N_pT_s$.  To maintain the same payload data rate:
\begin{equation}
\begin{split}
T_f &= T^\prime_f \\
(N_p-1)T_s &= N_pT_s \\
R^\prime_s &= R_s\frac{N_p}{N_p-1}
\end{split}
\end{equation}
where the symbol rate $R_s=1/T_s$.  Expressing $S/N$ (\ref{eq:snr}) in terms of $E_s$ and $R_s$:
\begin{equation}
\label{eq_snr_s}
\begin{split}
\frac{S}{N} &= \frac{E_sR_s}{N_0B} \\
\frac{S}{N}^\prime &= \frac{E_sR^\prime_s}{N_0B} \\
                   &= \frac{E_bR_sN_s}{N_0B(N_p-1)} \\
\frac{S^\prime/N}{S/N} &= \frac{N_p}{N_p-1}
\end{split}
\end{equation}
Thus when we insert pilots, the threshold $S/N$ increases by a factor of $N_p/(N_p-1)$. Expressed in $\si{dB}$:
\begin{equation}
\begin{split}
10log_{10}\left(\frac{S^\prime}{N}\right) &= 10log_{10}\left(\frac{S}{N}\right) + 10log_{10}\left(\frac{N_s}{N_s-1}\right) \\
SNR^\prime &= SNR + 10log_{10}\left(\frac{N_s}{N_s-1}\right) \\
SNR^\prime &= SNR + L_p  \quad [\si{dB}]
\end{split}
\end{equation}
where $L_p$ can be considered the pilot symbol \emph{loss} - the SNR degradation from the ideal performance (\ref{eq:snr}) due to the insertion of pilot symbols. For example FreeDV 700D uses a pilot insertion rate of $N_s=8$ results in $L_p=10log_{10}(8/7)=0.58 \, \si{dB}$, thus we need 0.58 dB more SNR to acheive the threshold SNR for the voice link.

\subsection{Cyclic Prefix Overhead}

TODO- fix, sould just be one factor of $1 - T_{cp}/T_s$ I think.

Now we consider the SNR overhead for the Cycle Prefix (CP) used in OFDM modems to cope with delay spread on multipath channels.  To achieve our payload data rate (e.g. 700 bits/s), we send symbols $D$ across the channel at a constant symbol rate $R_s$, or one symbol every $T=T_s$ seconds.  To cope with delay spread, we construct a composite symbol by pre-pending a Cyclic Prefix (CP) $T_{cp}$ seconds in duration to a new symbol $D^\prime$ of $T^\prime_s$ seconds in duration.  $D$ and $D^\prime$ contain the same PSK symbol, and convey the same information over the channel. The new composite symbol is now $T^\prime = T_{cp}+T^\prime_s$ seconds long.  The CP contains no additional information, it is just an extension of the single symbol $D^\prime$. Thus we still send one symbol of data over the channel every $T^\prime$ seconds.  To maintain the payload data rate over the channel, we must send the new composite symbol at the same rate as the original symbol:
\begin{equation}
\begin{split}
T &= T^\prime \\
T_s &= T_{cp} + T^\prime_s \\
R^\prime_s &= \frac{R_s}{1 - T_{cp}/T_s}
\end{split}
\end{equation}
It can be observed that $R^\prime_s > R_s$, to account for the portion of the composite symbol allocated to the CP.  For example with $R_s=700$, $T_s=0.02$, $T_{cp}=0.002$, $R^\prime_s=700/(1-0.002/0.02)=777.78$ symbols/second.

For the composite signal, the transmitter power $S$ is spread between the CP and $D^\prime$: 
\begin{equation}
S = \frac{T_{cp}}{T_s}S + \left(1 - \frac{T_{cp}}{T_s} \right)S
\end{equation}
Only the RH term contributes to the demodulation of $D^\prime$:
\begin{equation}
\begin{split}
\frac{S(1-T_{cp}/T_s)}{N} &= \frac{E_sR^\prime_s}{N_0B} \\
\frac{S}{N} &= \frac{E_sR^\prime_s}{N_0B}\frac{1}{(1-T_{cp}/T_s)}\\
            &= \frac{E_sR_s}{N_0B}\frac{1}{(1-T_{cp}/T_s)^2} \\
SNR         &= 10log10 \left( \frac{E_sR_s}{N_0B} \right) - 20log10(1-T_{cp}/T_s) \\
            &= 10log10 \left( \frac{E_sR_s}{N_0B} \right) + L_{cp} \quad [\si{dB}]
\end{split}
\end{equation}
Thus to close the link with the composite symbol the $S/N$ must be increased by a factor of $1/(1 - {T_s}/T_{cp})^2$ compared to our ideal modem.  This accounts for the energy allocated to the CP, and the shorter period $T^\prime_s$ of the symbol $D^\prime$.  The squared term suggest SNR is quite sensitive to increasing $T_{cp}$, which is necessary to handle fast fading, high delay spread channels such as MPD. For example FreeDV 700E has $Ts=0.02$, $T_{cp}=0.006$, giving $L_{cp}=-20log10(1-0.006/0.02)=3.1 \si{dB}$.

\subsection{HF Channel Model}

The two path HF channel model \cite{itu1487} is given by:
\begin{equation}
y(t) = x(t)G_1(t) + x(t-d)G_2(t)
\end{equation}
where $G_1$ and $G_2$ are two time varying, complex, Gaussian filtered random variables with \emph{Doppler Spread} bandwidth $B_d$ Hz, $d$ is the path delay in seconds. As $B_d<< R_s$ we assume $G_1$ and $G_2$ are complex constants for the duration of a single symbol. Expressed in discrete time for the current symbol:
\begin{equation}
y(n) = x(n)G_1 + x(n-dF_s)G_2
\end{equation}
where $F_s$ is the sample rate in $\si{Hz}$.  Taking the z-transform:
\begin{equation}
\begin{split}
Y(z) &= X(z)G_1+X(z)z^{-dF_s}G_2 \\
\frac{Y(z)}{X(z)} &= G_1+z^{-dF_s}G_2 \\
H(z) &= G_1+z^{-dF_s}G_2 \\
H(e^{j \omega}) &= G_1+e^{-j \omega d F_s}G_2
\end{split}
\end{equation}
For OFDM, the angular frequency of carrier $n$ is given by $\omega=2 \pi n R_s/F_s$, which can be used to derive a single complex coefficient that describes the channel for carrier $n$:
\begin{equation}
\label{eq:hf_model}
H_n = G_1+e^{-j 2 \pi R_s d}G_2
\end{equation} 

\section{Waveform Improvements}

In this section notes on (proposed) waveform improvements are presented.

The general strategy is to propose an innovation, and explore with analysis/maths and Octave simulation. Try low risk approaches to start with, then iterate.  To simulate performance with voice codec, use PER=0.1, BER=0.01 voice codec threshold for modem tests alone.

\subsection{Equalisation}

\begin{enumerate}
\item Pilot symbols are used to the estimate channel.  We require a 2 Hz bandwidth and low implementation loss $L_{il}$ in a noisy channel.
\item Each OFDM carrier experiences phase and amplitude shifts due to the channel impulse response.  For example consider two path simulation model (TODO ref, subsection), which has two time varying complex coefficients and delay.
\item Consider the two path HF channel model, comprised of two time varying complex coefficients, with bandwidth (-20dB) of $B=1 \si{Hz}$ (MPP).  The model is considered stationary over one symbol.
\item We should be able to reconstruct a 1 Hz bandwidth signal at 1 Hz sample rate, which suggests a low pilot insertion rate.  Other factors are adequate (in a modem performance sense) estimation in the presence of AWGN channel noise, and the short window of samples (at least fwd in time) that we can use, e.g. 4 samples total.
\item Each coefficient of the channel $h_n$ is a complex random variable with bandwidth $B$. Consider the channel model applied to steady state symbol (or a time varying PSK signal after ISI has settled). Two terms of bandwidth B add linearly, so by linearity the result also has bandwidth B.  The sum is a random modulation of bandwidth B about the symbol centre frequency.  The Doppler bandwidth $B$ therefore defines the bandwidth required for equalisation, independent of delay spread.
\item One caveat - if B an appreciable fraction of Rs the DFT orthogonality may break down to some extent as energy falls into adjacent DFT bins.  This could be explored by simulation too (or find a reference).
\item 700D samples pilots at $1/(N_pTs)=6.25 \si{Hz}$, which should be adequate for our target channels.  This will result in an acceptably low $L_{ps}$ SNR overhead.
\item 700D currently uses a block average over a 2D array of 12 pilots, this can be interpreted as a filter with all coefficients $c_i=1/12$. We may be able to do better with a different set of coefficients.  Use a simulation to explore.
\item Benefit - wide Doppler bandwidth, small pilot overhead, low noise channel estimator, one waveform for AWGN through to MPD.
\end{enumerate}

Take away notes from analysis and simulation (TODO edit and write up properly):
\begin{enumerate}
\item filter response is a combination of number of taps and cut off frequency
\item further work: an IIR filter if the delay could be managed 
\item if we just interpolate (cutoff = $\pi$) we could handle quite fast fading at high SNR, this might be an acceptable trade off.
\item We could provide bandwidth switches for Hams to experiment with, or people could try their own filter coefficients.
\item Curves AWGN, HF theory, HF with perfect phase est (amplitude fading only) as controls, then try different phase estimators
\item is one sample/modem frame OK?  Or should re resample for each data symbol?
\item seeing similar HF perf on lin2 (700E and data modes) and mean4 (700D-ish, at least in time).  Mean4 has sluggish freq response, but good filtering. lin2 doesn't filter noise much, but good freq response.  What really matters is HF.
\item Have sinc interpolator working, with some adjustments to delay and bandwidth.  As bandwidth is wider, it tracks time domain pilot noise better, rather than averaging it, so poor AWGN performance.  lin2 very hard to beat on fading channels (outperforms sinc at current bandwidths), and so simple, due to oversampling.  Thickness of arms is a good indication of fading perf.   lin2 works above 2 Hz.
\item "bandwidth" interpretation of mean4 also shows how it is impacted by fast fading.
\item We are showing reasonable HF perf with Np=8, Ts=0.02, 1dB off hf theory for 1Hz, 2dB for 2Hz Doppler - in a single mode.  So this is progress towards our single mode goal, with 0.4dB saving in $L_p$ and bandwidth savings using $N_p=8$. It would be nice to improve slow fading/AWGN perf, and get closer to ideal HF.
\item idea: try lin2 with adajacent carriers, to see if HF gets closer to ideal and we improve AWGN.  Accidental plotting of time domain adjacent carrier is instructive.  Phase shift of 2nd phase term of adjacent carriers is symmetrical which might help.  It is proportonal to delay spread so we may see more degredation.  lin2 AWGN Improved by 1dB (now 0.5dB), fading improved about 0.5dB (now 1dB).
\item Same Np, Lp as 700D, but works on 2 Hz (and beyond) fading.  If channel improves, users get benefit of improved perf (unlike 700E where you're stuck with needing a high SNR)).  Less use of bandwidth I think as less pilot overhead (so room for tx diversity). Potential down side is 0.5dB off AWGN for 700D, and (maybe) some loss from bigger CP.  Put perhaps longer symbol will help that.
\item When correct 4ms delay used for MPD, freq weighting breaks it!  This is explained by (\ref{eq:hf_model}), as $d$ increases phase shift between carriers is greater.  Unfortunately this implies different phase estimators for different channels, something we would like to avoid. Parallel demodulators might be a reasonable approach here - try two different phase estimators.
\end{enumerate}

Combining pilots from adjacent carriers is used in FreeDV 700D to reduce estimation noise.  Examining (\ref{eq:hf_model}) we can see some symmetry in the RH term in the phase between carrier $n-1$ and carrier $n+1$ which supports averaging over adjacent carriers to estimate $H_n$, especially when the term $2 \pi R_s d$ is small.  A more robust approach is to perform a least squares fit of three equations with $G_1$ and $G_2$ as the two unknowns, and $H_{-1}, H_0, H_1$ as the three pilot samples centred around the current carrier:
\begin{equation}
\begin{split}
G_1 + G_2 e^{j 2 \pi R_sd} &= H_{-1} \\
G_1 + G_2 &= H_{0} \\
G_1 + G_2 e^{-j 2 \pi R_sd} &= H_{1} \\
\begin{bmatrix}
  1 & e^{j 2 \pi R_sd} \\
  1 & 1 \\
  1 & e^{-j 2 \pi R_sd}
\end{bmatrix} 
\begin{bmatrix}
  G_1 \\
  G_2
\end{bmatrix} 
&= \begin{bmatrix}
  H_{-1} \\
  H_{0} \\
  H_{1}
\end{bmatrix} \\
Ag &= h \\
 g &= (A^TA)^{-1}A^Th \\
 \overline{H_0} &= G_1 + G_2
\end{split}
\end{equation} 

where $\overline{H_0}$ is the smoothed estimate of the current carriers pilot symbol.  The $(A^TA)^{-1}A^T$ term can be precomputed as all the parameters of $A$ are known. 

\subsection{Multipath}

n=2 diversity to handle multipath.  Say 3dB gain on MPP/MPD.  Research combining techniques. Risks are copies will have half power so estimates will have more noise.

\subsection{FEC}

If we use diversity, I am not sure how much FEC we can also use, as we may run out of bandwidth.  Alternative is MAP techniques or some combination of MAP and FEC.

\subsection{Delay Spread (ISI)}

\begin{enumerate}
\item We need a CP long enough to handle MPD (4ms plus guard)
\item Try longer $T_s$ which will mean less overhead. However this implies lower $R_s$ which may be impacted by frequency spreading effect of Doppler.  Caveat (as in equalisation section) is possible issues with Doppler spread and frequency offset tracking as $R_s$ reduces.
\item Measure implementation loss or EVM against ISI, we might be able to get away with some ISI, it is acceptable to have performance drop off for MPD, but it needs to be gradual rather than breaking.
\item 700C had just 13ms symbols but dealt with ISI pretty well - this might be worth exploring.
\end{enumerate}

\subsection{Acquisition}

TODO: also include frequency offset estimation and tracking.  Sensitivity of Doppler spread, freq offset errors with reduced $R_s$. Can we use othogonality property to track freq offset, e.g. iterative adjustments of offset to peak OFDM carriers?

\section{Further Work}

This section presents topics useful to explore in future.

\begin{itemize}
\item Can we include PAPR into model? Can we have different trajectories for QPSK symbols around unit circle that reduce PAPR?  No I don't think that helps when multiple carriers are added together.  ECSSB techniques may be useful.
\item Expression for Fading channels, block error rate, why 2020 is a lemon.
\item Table of FreeDV waveforms and values, plugged into formula, effect of increasing pilot symbol rate.
\item Where we can gain, diversity, PAPR reduction, reduced overheads for fast fading and ISI (discuss)
\item Wades MAP techniques (ref).  This has a lot of promise, need an effective way to simulate and establish benefit with a modest amount of work.  Without a rate 0.5 code this would free up a lot of bandwidth to deal with ISI better, e.g. we could have large gaps between symbols.  Or use parallel tone modem to reduce effects of ISI.  A high rate code on top of this may be useful option (if it can converge).   Can we combine MAP with extra bits?  Index optimisation also a simple approach.
\end{itemize} 

\bibliographystyle{plain}
\bibliography{freedv_low_refs}
\end{document}
