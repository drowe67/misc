\documentclass{article}
\usepackage{amsmath}
\usepackage{hyperref}
\usepackage{tikz}
\usetikzlibrary{arrows}
\usepackage[numbib]{tocbibind}
\usepackage{float}
\usepackage{array}

\begin{document}

\title{Analog Transmission of Vocoder Features over Radio Channels}
\maketitle

Given a vector of vocoder features $\bf{f}$, use an autoencoder $E$ to map them to a dimension $d$ latent vector $\bf{z}$ where $d$ is even.  Unlike digital modulation, each element $z_i$ of $\bf{z}$ is continuously valued and not constrained to a discrete set of points.  For bandwidth efficient transmission over the channel the elements of $\bf{z}$ are mapped to $d/2$ complex symbols $\bf{q}$. Compared to classical digital modulation, the elements of $\bf{z}$ can be considered BPSK symbols (continuously valued, analog bits), and the elements of $\bf{q}$ analog QPSK symbols.

Our goal is to determine if reasonable speech quality can be obtained over a channel of bandwidth $B<3000$ Hz and SNR (measured in $B=3000$ Hz) of between 0 and 6dB, roughly the lower limit of Single Side Band (SSB) - a common power and bandwidth efficient form of analog radio communication.

\section{Simulation of AWGN Channels}

The autoencoder output $\bf{z}$ is updated every $T_z=1/R_z$ seconds, giving a BPSK symbol rate of:
\begin{equation}
R_b=d/T_z
\end{equation}
For example with $T_z=0.04, d=80, R_b=2000$ symbols/s.  The QPSK symbol rate is given by:
\begin{equation}
R_q = \frac{d}{2T_z} 
\end{equation}
For example with $T_z=0.04, d=80, R_q=1000$ symbols/s.

\begin{figure}[H]
\caption{Real sampled off-air signal.  We are interested in the blue bandpass interval of bandwidth $B$, which is single sided and hence complex valued. After shifting to baseband, it's power is unchanged, and it remains complex valued.}
\vspace{5mm}
\label{fig:bandpass}
\begin{center}
\begin{tikzpicture}[>=triangle 45,x=1.0cm,y=1.0cm]
\draw[thick,->] (-6,0) -- (6,0) node [below, align=left, text width=3cm]{Frequency};
\draw[thick,->] (0,0) -- (0,3);
\draw (-3,0) -- (-3,2) -- (-1,2) -- (-1,0);
\draw[blue] (1,0) -- (1,2) -- (3,2) -- (3,0);
\draw[<->] (1,1) -- node [above]{$B$}(3,1); 
\draw[->] (2,-0.5)  node [below]{$\omega$} -- (2,0);
\end{tikzpicture}
\begin{tikzpicture}[>=triangle 45,x=1.0cm,y=1.0cm]
\draw[thick,->] (-6,0) -- (6,0) node [below, align=left, text width=3cm]{Frequency};
\draw[thick,->] (0,0) -- (0,3);
\draw (-5,0) -- (-5,2) -- (-3,2) -- (-3,0);
\draw[blue] (-1,0) -- (-1,2) -- (1,2) -- (1,0);
\draw[->] (0,-0.5)  node [below]{$\omega=0$} -- (0,0);
\end{tikzpicture}
\end{center}
\end{figure}

We wish to simulate an AWGN channel with a user-defined $E_b/N_0$, where $E_b$ is the energy of each BPSK symbol, and $N_0$ is the noise power per unit bandwidth.  Consider a real valued signal sampled off air (Figure \ref{fig:bandpass}).  We will follow convention and define signal and noise power in the ``single sided" bandpass interval of the frequency spectrum with bandwidth B centered on $\omega$.  As the interval is single sided, we must use complex valued quantities to represent it.

We wish to simulate a bandpass AWGN channel at baseband ($\omega=0$).  This implies a frequency shift of the complex valued signal, but the signal remains complex valued and it's power is unchanged. The negative frequency component on the LHS of Figure \ref{fig:bandpass} is redundant and after frequency shifting can be removed by filtering.

Note that even at baseband we must use complex valued quantities for the signal and noise to represent a bandpass signal of bandwidth $B$.  For example, given a fixed sample rate $B$ and noise power $N$, a real valued noise sequence can only represent a bandwidth of $B/2$ which results in doubling the noise density $N_0=N/(B/2)=2N_0$ compared to a complex valued noise sequence with the same power.   

The energy of each BPSK symbol $E_b$ is the signal power $S$ divided by the symbol rate $R_b=1/T_b$.  The noise per unit bandwidth is the total noise power $N$ divided by the bandwidth $B$ of the system.  If we are simulating at one sample per symbol, $B=R_b$:
\begin{equation}
\begin{split}
\frac{E_b}{N_0} &= \frac{S/R_b}{N/R_b} \\
                &= \frac{S}{N} \\
                &= \frac{A^2}{\sigma^2}
\end{split}
\end{equation}
where $A$ is the amplitude of each BPSK symbol and $\sigma^2=N$ is the variance of the complex valued noise (mean noise energy per sample).  Given a set point $E_b/N_0$:
\begin{equation}
\label{eq:noise_sigma}
\sigma = \frac{A}{\sqrt{E_b/N_0}}
\end{equation}
The complex noise sample $r_i$ can be generated as:
\begin{equation}
r_i = \frac{\sigma}{\sqrt{2}}(\mathcal{N}_{2i}(0,1) + j\mathcal{N}_{2i+1}(0,1))
\end{equation}
where $\mathcal{N}_i(0,1)$ is the $i-th$ sample of a unit variance, zero mean, real Gaussian noise source.  Note the noise power is split evenly between the real and imaginary arms. Our symbols passing through an AWGN channel can be simulated at complex baseband as:
\begin{equation}
\begin{split}
\hat{z}_i &= z_i + r_i \\
\hat{q}_i &= q_i + r_i
\end{split}
\end{equation}
If the noise is zero mean, we can estimate $\sigma^2$ over $K$ noise samples $r_i$ as:
\begin{equation}
\sigma^2 = E[|r_i|^2] = \frac{1}{K}\sum_{i=0}^{K-1}|r_i|^2 
\end{equation}

\subsection{SNR Measurement}

In order to compare with other methods of speech communication that have varying bandwidths $B$, it is useful to formulate expressions for estimating SNR from the BPSK and QPSK symbols.  The Signal to Noise ratio (SNR) is given by:
\begin{equation}
\label{eq:snr_theory}
\begin{split}
\frac{S}{N} &= \frac{E_bR_b}{N_0B} \\
            &= \frac{E_qR_q}{N_0B}
\end{split}
\end{equation}
A noise bandwidth $B$ needs to be selected; common choices are $B=R_b$, in which case $S/N=E_b/N_0$; for HF radio $B=3000$ Hz to compare with existing analog and digital voice waveforms; or $B=1$ to obtain a normalised $C/N_0$ carrier power to noise density ratio - useful for comparing waveforms with different bandwidths.
 
At one sample per symbol, the power, the mean energy of each QPSK symbol over a window of $K$ samples is given by:
\begin{equation}
E_q = E[|q_i|^2] = \frac{1}{K}\sum_{i=0}^{K-1}|q_i|^2
\end{equation}
Note the variance function should not be used to calculate $E_q$, as we cannot guarantee $q_i$ is zero mean. As each QPSK symbol contains 2 BPSK symbols, the energy is split evenly:
\begin{equation}
E_b = E_q/2
\end{equation}
For example if the symbol amplitude is $A=1, E_b=A^2=1$, then $E_q=1+1=2$.

To model transmission over multipath channels using OFDM we arrange the QPSK symbols as $N_c$ parallel carriers, each running at a symbol rate of $R_s=R_q/N_c$ symbols/s, where $R_s$ is chosen based on delay spread considerations.  Typical values for HF modems are $N_c=20$ and $R_s=50$ Hz. However the OFDM carriers are arranged such that the total symbol rate over the channel remains constant.  So for a given signal power $E_q$ and $E_b$ remain constant (Table \ref{tab:constant_eb}).

\begin{table} [H]
\centering
\begin{tabular}{l l l l l l l}
 \hline
 Waveform            & $N_c$ & $R_s$ & $R_q$ & $R_b$ & $E_q$ & $E_b$ \\
 \hline
 Single Carrier BPSK & 1     & -  & -    & 2000  & -        & $S/2000$ \\
 Single Carrier QPSK & 1     & -  & 1000 & 2000  & $S/1000$ & $S/2000$ \\
 OFDM QPSK           & 20    & 50 & 1000 & 2000  & $S/1000$ & $S/2000$ \\
 \hline
\end{tabular}
\caption{$E_b$ and $E_q$ examples for single and multi-carrier OFDM waveforms for constant carrier power $S$}
\label{tab:constant_eb}
\end{table}

\subsection{Calibration and Testing}

In order to evaluate the ML system early in the development process it is important to ensure the noise is correctly calibrated. The expressions above can be used to check the noise injection process:
\begin{enumerate}
\item Set a target $E_b/N_0$ for the simulation run, and calculate $\sigma$ using (\ref{eq:noise_sigma}).
\item Establish the equivalent target SNR from (\ref{eq:snr_theory}) evaluated using the target $E_b/N_0$.
\item After the simulation run measure $E_q=E[|q_i|^2]$ over a sample of transmitted symbols.  Note that in general $E_q \ne 2$ as the encoder outputs continuous values.
\item Calculate measured SNR using (\ref{eq:snr_theory}) and compare.
\end{enumerate}

The calibration of the noise injection can be checked by replacing the encoder output $z_i$ with discrete PSK symbols to create a digital modem, then measuring the BER at $E_b/N_0$ points. The theoretical BER over an AWGN channel is:
\begin{equation}
\label{eq:ber_awgn}
BER = 0.5erfc(\sqrt{E_b/N_0})
\end{equation}
For a multipath channel:
\begin{equation}
\label{eq:ber_multipath}
BER = 0.5 \left(1-\sqrt{\frac{E_b/N_0}{E_b/N_0+1}} \right)
\end{equation}


\section{Over the Cable and Over the Air Tests}

Impressive results have been obtained from the symbol rate simulations of an OFDM modem.  These assumed ideal synchronisation.  We would like to verify these results using real radio signals in Over The Cable (OTC) and Over the Air (OTA) tests.  This requires building up a rate $Fs_s$ system, and synchronisation subsystems.  For a first pass, the choice was made to use classical DSP pilot symbol based syncronisation, although we acknowldge potential for ML based syncrohinisation in future iterations.

The goal is to compare speech quality to SSB at $E_b/N_0=0dB$ (approx -3dB SNR in a 3000Hz BW), and work through any issues that prevent the system working over real radio channels.  PAPR will be ignore for the first pass tests, as we are mainly concerned with verifiying the low $E_b/N_0$ results suggested by the symbol rate simulations.

Pilot symbols have been inserted into each OFDM carrier at a rate of one pilot every 4 data symbols.  From \cite{freedv_low}, the SNR loss from injecting the pilot symbols is given by:
\begin{equation}
L_p = 10log_{10}\frac{N_s}{Ns-1}
\end{equation}
For $N_s=5$, the loss in 0.96dB.  To maintain the same payload symbol rate over the channel, the bandwidth increases:
\begin{equation}
R^\prime_b = R_b\frac{N_s}{N_s-1}
\end{equation}
For $N_s=5$, $R^\prime_b=2500$ symbols/s, or a OFDM QPSK bandwidth of around 1250 Hz plus some guard bandwidth.

A pilot based sync system was built in PyTorch, and is used for coarse and fine timing, phase and amplitide equalisation.  Unlike regular PSK, the ML network is likely to be senstive to amplitude variations.  Phase equalisation also allows small frequency offsets ($\pm2$ Hz) to be tracked.

Several phase estimators were prototyped, and tested using BER measurements. Maintaining low loss syncronisation at low $E_b/N_0$ is challenging.  As further work a lower latent dimension $d$ and higher $E_b/N_0$, would allocate more power to pilots, and result in less carriers.  Using per-carrier phase estimation makes the system less dependant on fine timing accuracy and gives us the ability to handle multipath, but has higher loss tham algorithms that consdier all carriers at the same time.

\begin{figure}[h]
\caption{OFDM pilot based synchronisation algorithm performance, tested with digital PSK symbols on an AWGN channel. With ideal sync, intelligable speech is produced at $E_b/N_0=-6$ dB or BER=0.24.}
\label{fig:ofdm_sync}
\begin{center}
\input ofdm_sync.tex
\end{center}
\end{figure}

Figure \ref{fig:ofdm_sync} plots the perfomance of the OFDM pilot based synchronisation system used for the OTC/OTA tests on an AWGN channel.  The unsually low $E_b/N_0$ range we are considering is challenging.  The \emph{genie} curve is the baseline rate $F_s$ OFDM system with ideal sync, and matches the theoretical results.  Using this system, we can obtain intelligable speech at $E_b/N_0=-6$, or BER=0.24 in a digital system.  We can use the BER=0.25 line to estimate the loss of the synchronisation based system at this operating point, which for the \emph{mean6} and \emph{LS} algorithms under realistic conditions is around 2 to 2.4 dB. The \emph{LS} works better on fast fading multipath channels.

Combined with $L_p$, we estimate a total sync loss of 3dB for this first pass of the ML system combined with classical pilot based syncronisation. However we note that no cyclic prefix has been added at this time.

TODO Figure of OFDM frame.  TODO Block diagram of OTC tests

Further work:
\begin{enumerate}
\item Try a low dimesnions latent vector, e.g. $d=40$, and see if similar speech quality can be obtained at 3dB high $E_b/N_0$. This would result in lower sync losses, as the $Eb/N_0$ of the pilots would be increased. Does the encoder output still resemble BPSK, or is it training to a higher order constellation?
\item Attempt to use the ML network to perform frequency, phase and amplitude equalisation, wither with or without passing the pilots to the decoder.  Some initial results without pilots resultying in some performance degredation, however this may be acceptable if it is in the same order as the pilot based sync losses. Some pilot or unique word injection may still be required to perform coarse and fine timing estimation using classical DSP running at the sample rate.
\item Work to improve the current classical DSP sync, e.g. a feedback loop to track out frequency offsets is worth 1 dB.
\item Include PAPR optimisation and rate $F_s$ multipath channels in the training.
\item A better analog compressor.
\end{enumerate}

\section{Comparison with Other Speech Waveforms}

We wish to compare our radio autoencoder with existing waveforms used for speech transmission over radio channels.  We start with the assumption that we have a transmitter of $C$ watts, and an AWGN channel with a spectral noise density of $N_0$ watts/Hz. As the speech waveforms being considered vary in bandwidth we will choose $C/N_0$ as the SNR metric.

The $C/N_0$ (in dBHz) at the demodulator input of a terrestrial radio receiver is given by:
\begin{equation}
\frac{C}{N_0} = P - PAPR - L_{path} - NF + 174
\end{equation}
where $P$ is the maximum output power of the transmitter power amplifier, $PAPR$ is the Peak to Average Power Ratio of the waveform, $L_{path}$ is the path loss, $NF$ is the noise figure of the receiver.  For example consider a 400 MHz FM hand held radio over a 1km urban (non line of site) path.  The radio has a 1W (30 dBm) power output, $L_{path}=120$ dB, with noise dominated by ambient EMI such that $NF=10$ dB. $C/N_0 = 30 - 0 - 120 - 10 + 174 = 74$ dBHz, sufficient for good quality speech (Table \ref{tab:waveforms_good}).

Note that $C/N_0$ at the demodulator is a function of PAPR.  A high PAPR reduces the $C/N_0$ at the receiver.  We effectively ``back off" the transmitter power from the maximum $P$ by the PAPR.  We assume the PA is capable of sustaining $P$ watts indefinately. As PAPR varies by waveform, it should be included in any metric for comparison of waveforms.  We define $P/N_0$ as:
\begin{equation}
P/N_0 = C/N_0 + PAPR
\end{equation} 
A waveform that delivers intelligable speech at a low $P/N_0$ is the target.  A low PAPR waveform has other desirable properties, such as greater PA efficiency, longer battery life, and low cost semiconductors.

\begin{table} [H]
\centering
\begin{tabular}{  m{3.5cm} | m{7cm}  }
 \hline
 Waveform             & Threshold \\
 \hline
 Single Sideband      & 0dB SNR in 3000Hz noise BW, 2400Hz audio bandwidth, Tx speech compressor with 6dB PAPR \\
 Frequency Modulation & -120 dBm quoted for many NBFM radios, 54dB above -174dBm/Hz noise floor \\
 FreeDV 700D          & 10\% PER theshold at -2dB SNR in 3000Hz noise BW \\
 Radio Autoencoder    & Intelligable speech at $E_b/N_0=-6$ dB, $R_b=2000$ symbols/s, 3dB sync overhead \\
 \hline
\end{tabular}
\caption{Thresholds for speech link closure for each waveform. The link is considered closed when the speech is barely intelligable to a trained listener.}
\label{tab:waveforms_thresh}
\end{table}

\begin{table} [H]
\centering
\begin{tabular}{  m{3.5cm} | m{7cm}  }
 \hline
 Waveform             & Threshold $C/N_0$ calculations (dBHz) \\
 \hline
 Single Sideband      & $0 + 10log10(3000) = 35$ \\
 Frequency Modulation & $-120 + 174 = 54$ \\
 FreeDV 700D          & $-2 + 10log10(3000) = 33$ \\
 Radio Autoencoder    & $-6 + 10log10(2000) + 3 = 30$ \\
 \hline
\end{tabular}
\caption{Threshold $C/N_0$ calculations.}
\label{tab:waveforms_thresh_calc}
\end{table}

\begin{table} [H]
\centering
\begin{tabular}{l l r r r r r}
 \hline
 Waveform             & Abbr  & RF BW & PAPR & $C/N_0$ & $P/N_0$ & $\Delta$ \\
 \hline
 Single Sideband      & SSB   & 2400  &  6 & 35 & 41 & -10 \\
 Frequency Modulation & NBFM  & 16000 &  0 & 54 & 54 & -23 \\
 FreeDV 700D          & 700D  & 1100  &  4 & 33 & 37 & -6  \\
 Radio Autoencoder    & radAE & 1400  &  1 & 30 & 31 &  0  \\
 \hline
\end{tabular}
\caption{Comparison of link closure by waveform over AWGN channels.}
\label{tab:waveforms_linkclosure}
\end{table}

\begin{table} [H]
\centering
\begin{tabular}{l r r r r}
 \hline
 Waveform             & Audio BW & $C/N_0$ & $P/N_0$ & $\Delta$ \\
 \hline
 Radio Autoencoder    & 8000 & 36 & 37 &   0 \\
 Frequency Modulation & 3000 & 64 & 64 & -27 \\
 Single Sideband      & 2000 & 55 & 61 & -24 \\
 \hline
\end{tabular}
\caption{Comparison of good quality ``arm chair copy" by speech waveform over AWGN channels. They are ranked in terms of maximum achievable speech quality. FreeDV 700D has been omitted because of its low speech quality even in ideal channels. The radio autoencoder delivers wideband (8000 Hz) audio.}
\label{tab:waveforms_good}
\end{table}

\section{Glossary}

\begin{table} [H]
\centering
\begin{tabular}{l l l}
 \hline
 Symbol & Explanation & Units \\
 \hline
 $B$ & noise or signal bandwidth & Hz \\
 $C$ & Carrier (transmitter) power $C=S$ for this study \\
 $C/N_0$ & Carrier power/spectral noise density \\
 $d$ & dimension of latent vector $\bf{z}$ \\
 $E_b/N_0$ & energy per BPSK symbol on spectral noise density \\
 $E_q/N_0$ & energy per QPSK symbol on spectral noise density \\
 $N$ & total noise power & Watts \\
 $N_c$ & Number of carriers  \\
 $N_0$ & Noise power in 1 Hz of bandwidth  \\
 $P/N_0$ & Peak trasnmitter power/spectral noise density \\
 $\bf{q}$ & vector of QPSK symbols \\ 
 $q_i$ & single QPSK symbol, element of $\bf{q}$ \\ 
 $R_b$ & BPSK symbol rate & symbols/second \\
 $R_q$ & QPSK symbol rate & symbols/second \\
 $R_s$ & OFDM per carrier QPSK symbol rate & symbols/second \\
 $R_z$ & latent vector update rate & Hz \\
 $SNR$ & signal to noise Ratio \\
 $S$ & total signal (carrier) power & Watts \\
 $T_b$ & BPSK symbol period & seconds \\
 $T_q$ & QPSK symbol period & seconds \\
 $T_s$ & OFDM per carrier QPSK symbol period & seconds\\
 $T_z$ & time between latent vector updates & seconds\\
 $r_i$ & noise sample \\
 $\bf{z}$ & Autoencoder output latent vector \\ 
 $z_i$ & single latent vector element of $\bf{z}$, a BPSK symbol \\ 
 \hline
\end{tabular}
\caption{Glossary of Symbols}
\end{table}

\nocite{*}
\bibliographystyle{plain}
\bibliography{radae_refs}
\end{document}


\end{document}
